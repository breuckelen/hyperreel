# @package _group_

type: lightfield

render:
  type: lightfield

param:
  n_dims: 6
  fn: identity


### EMBEDDING ###
embedding:
  type: ray_point

  embeddings:
    ray_prediction_0:
      type: ray_prediction

      # Parameterization
      params:
        ray:
          start: 0
          end: 6

          param:
            n_dims: 6
            fn: pluecker

          pe:
            type: basic
            n_freqs: 1

      # Net
      net:
        type: base
        group: embedding_impl

        depth: 6
        hidden_channels: 256
        skips: [3]

      #z_channels: 8
      z_channels: 32

      outputs:
        z_vals:
          channels: 4

        sigma:
          channels: 1

          activation:
            type: ease_in_value
            start_value: 1.0
            window_epochs: 0
            wait_epochs: 0

            activation:
              type: sigmoid
              shift: 3.0

    ray_intersect_0:
      type: ray_intersect

      #z_channels: 8
      z_channels: 32

      intersect:
        type: sphere

        sort: False
        use_sigma: True

        out_points: raw_points
        out_distance: raw_distance

        use_dataset_bounds: True
        origin_scale_factor: 0.0

        mask:
          stop_iters: -1

        contract:
          type: mipnerf
          contract_samples: True
          use_dataset_bounds: True

        #z_scale: 0.125

        #activation:
        #  type: identity
        #  fac: 0.5

        activation:
          type: tanh
          inner_fac: 0.25
          outer_fac: 4.0

    point_prediction_0:
      type: point_prediction

      #in_z_channels: 8
      in_z_channels: 32
      net_in_z_channels: 1
      out_z_channels: 32

      inputs:
        points: 3
        viewdirs: 3

      params:
        points:
          start: 0
          end: 3

          param:
            n_dims: 3
            fn: identity

          pe:
            type: basic
            n_freqs: 2

        dirs:
          start: 3
          end: 6

          param:
            n_dims: 3
            fn: identity

          pe:
            type: basic
            n_freqs: 1

      net:
        type: base
        group: embedding_impl

        depth: 6
        hidden_channels: 256
        skips: [3]

      outputs:
        z_vals:
          channels: 4

        sigma:
          channels: 1

          activation:
            type: ease_in_value
            start_value: 1.0
            window_epochs: 3
            wait_epochs: 0

            activation:
              type: sigmoid
              shift: 4.0

        point_sigma:
          channels: 1

          activation:
            type: ease_in_value
            start_value: 1.0
            window_epochs: 3
            wait_epochs: 0

            activation:
              type: sigmoid
              shift: 4.0

        point_offset:
          channels: 3

          activation:
            type: tanh
            outer_fac: 0.125

      ray_outputs: # TODO: Remove
        color_scale:
          channels: 3

          activation:
            type: ease_in_value
            start_value: 0.0
            window_epochs: 0
            wait_epochs: 0

            activation:
              type: identity
              shift: 0.0
              inner_fac: 1.0
              outer_fac: 1.0

        color_shift:
          channels: 3

          activation:
            type: ease_in_value
            start_value: 0.0
            window_epochs: 0
            wait_epochs: 0

            activation:
              type: identity
              shift: 0.0
              inner_fac: 1.0
              outer_fac: 1.0

    copy_fields_0:
      type: add_fields

      fields:
        distances_no_contract:
          start: 0
          end: 1
        
      out_field: last_distance

    ray_intersect_1:
      type: ray_intersect

      z_channels: 32

      intersect:
        type: sphere

        sort: True
        sort_outputs: [point_sigma, point_offset, color_scale, color_shift]

        use_sigma: True

        residual_z: True
        #round_centers: True
        #round_size: 0.125

        initial: -0.0 # NOTE: New
        end: 0.0 # NOTE: New
        z_scale: 0.0625

        use_dataset_bounds: True
        origin_scale_factor: 0.0

        contract:
          type: mipnerf
          contract_samples: True
          use_dataset_bounds: True

        #z_scale: 0.125

        #activation:
        #  type: identity
        #  fac: 0.5

        activation:
          type: tanh
          inner_fac: 0.25
          outer_fac: 4.0

    #point_offset_0:
    #  type: point_offset
    #  use_sigma: True

    #sort_outputs_0:
    #  type: sort_outputs
    #  in_distance_field: distances
    #  sort_outputs: [points, point_sigma, point_offset, color_scale, color_shift]

    #generate_distances_0:
    #  type: generate_distances
    #  in_origin_field: origins
    #  in_points_field: points
    #  out_distance_field: distances

    point_prediction_1:
      type: point_prediction

      in_z_channels: 32
      out_z_channels: 32

      inputs:
        points: 3

      params:
        ray:
          start: 0
          end: 3

          param:
            n_dims: 3
            fn: identity

          pe:
            type: basic
            n_freqs: 2

      net:
        type: fast_net
        opt_group: embedding_impl_large

        otype: FullyFusedMLP

        depth: 6
        hidden_channels: 128

      outputs:
        point_sigma_3d:
          channels: 1

          activation:
            type: ease_in_value
            start_value: 1.0
            window_epochs: 3
            wait_epochs: 0

            activation:
              type: sigmoid
              shift: 4.0

        point_offset_3d:
          channels: 3

          activation:
            type: ease_in_value
            start_value: 0.0
            window_epochs: 0
            wait_epochs: 0

            activation:
              type: tanh
              outer_fac: 1.0

        point_transform_3d:
          channels: 9

          activation:
            type: ease_in_value
            start_value: 0.0
            window_epochs: 0
            wait_epochs: 0

            activation:
              type: tanh
              outer_fac: 1.0

    point_offset_1:
      type: point_offset
      in_density_field: point_sigma_3d
      in_offset_field: point_offset_3d
      use_sigma: True

    point_transform_1:
      type: point_transform
      in_density_field: point_sigma_3d
      in_transform_field: point_transform_3d
      use_sigma: True

    add_point_outputs_0:
      type: add_point_outputs
      extra_outputs: ['viewdirs']

    extract_fields:
      type: extract_fields
      fields: ['points', 'distances', 'viewdirs', 'weights', 'color_scale', 'color_shift']


### COLOR ###
color:
  type: base

  net:
    type: tensor_vm_split_no_sample

    # Scene hyper-params
    white_bg: 0
    black_bg: 0

    # Density activation
    fea2denseAct: relu
    distance_scale: 16.0
    density_shift: 0.0

    # Grid bounds
    aabb: [[-2.0, -2.0, -2.0], [2.0, 2.0, 2.0]]

    # Grid size and upsampling
    N_voxel_init: 3375000
    #N_voxel_init: 512000
    N_voxel_final: 216000000

    upsamp_list: [4000,6000,8000,10000,12000]
    lr_upsample_reset: True

    # Thresholding
    update_AlphaMask_list: [4000,8000]
    rm_weight_mask_thre: 0
    alpha_mask_thre: 1e-3

    # Tensor sizes
    n_lamb_sigma: [8,4,4]
    n_lamb_sh: [8,4,4]

    ## Shading
    shadingMode: RGB
    data_dim_color: 3


